# 프로그램 명세서

## 1. 개요

### 1.1 목적
`use-hybrid-app.ts`는 Nuxt.js 기반의 하이브리드 애플리케이션에서 웹과 네이티브 앱 간의 통신을 담당하는 핵심 컴포저블(composable)입니다. 이 파일은 iframe 내부의 콘텐츠와 외부 프레임워크 간의 상호작용을 관리하며, 카메라, 오디오, 이미지 처리, STT(음성인식) 등 다양한 멀티미디어 기능을 제공합니다.

### 1.2 주요 기능
- **하이브리드 앱 브리지**: 웹뷰와 네이티브 앱 간의 통신 인터페이스
- **멀티미디어 관리**: 카메라, 오디오, 이미지 캡처 및 처리
- **음성인식(STT)**: 실시간 음성-텍스트 변환
- **학습 진행 관리**: 메뉴 상태, 단계, 완료 상태 관리
- **파일 업로드/다운로드**: 이미지 및 오디오 파일 처리

## 2. 아키텍처

### 2.1 파일 구조
```
composables/use-hybrid-app.ts
├── 상태 관리 (ref 변수들)
├── 메인 함수 (useHybridApp)
├── iframe 이벤트 초기화 (initFrameEvt)
├── 하이브리드 앱 API 함수들
├── 메시지 처리 (postMsgAction)
└── 유틸리티 함수들
```

### 2.2 의존성
- **Nuxt.js Composition API**: `@nuxtjs/composition-api`
- **타입 정의**: `@/types/frame`, `@/types/menu`, `@/types/popup`
- **유틸리티**: `@/utils/record/Recorder`, `@/utils`
- **외부 라이브러리**: CreateJS (Canvas 처리)

## 3. 핵심 기능 상세

### 3.1 하이브리드 앱 브리지 (HybridApp)
```typescript
ifWin.HybridApp = {
  // 서버 타입 관리
  getServerType: () => string,
  
  // 콘텐츠 완료 관리
  completeContents: () => void,
  
  // 메뉴 관리
  getMenuCount: () => number,
  getMenuIndex: () => number,
  nextMenu: () => void,
  setMenu: (menuIdx: number) => void,
  resetMenu: (menuIdx: number) => void,
  
  // 데이터 관리
  setData: (strData: string) => void,
  getData: () => string,
  setInstantData: (strData: string) => void,
  getInstantData: () => string,
  
  // 단계 관리
  setLastStep: (nStep: number) => void,
  getLastStep: () => number,
  
  // 상태 관리
  getNowStatus: () => number
}
```

### 3.2 카메라 및 이미지 처리
```typescript
// 카메라 프리뷰 시작
startCameraPreview: (camFacing, x, y, width, height) => void

// 카메라 프리뷰 저장
saveCameraPreview: (callback) => void

// 화면 캡처
capture: (callback) => void

// 이미지 저장 및 업로드
saveBase64ImgToPng: (filename, base64Data) => string
captureNSave: (callbackName, path, quality) => void
```

### 3.3 오디오 및 녹음 관리
```typescript
// 녹음 시작/중지
startRecord: (id: string) => Promise<void>
stopRecord: () => Promise<void>

// 사운드 재생 제어
playSound: (id, loop, volume, callback) => void
pauseSound: (id) => void
resumeSound: (id) => void
seekSound: (id, milliseconds) => void

// 볼륨 및 시간 관리
setVolume: (id, volume) => void
getSoundDuration: (id) => number
getSoundCurrent: (id) => number
```

### 3.4 음성인식(STT) 시스템
```typescript
// STT 모드 시작
startSilvySTTMode: (model, uiType, text?, answer?) => void

// STT 모드 중지
stopSilvy: () => void

// 음성인식 결과 처리
onResultSTTMode: (result) => void
```

### 3.5 학습 진행 관리
```typescript
// 학습 상태 확인
isFirstLoadedMenu: () => boolean
isContinueStudy: () => boolean

// 학습 완료 처리
completeContents: () => void

// 메뉴 이동 및 리셋
nextMenu: () => void
resetMenu: (menuIdx: number) => void
```

### 3.6 파일 업로드/다운로드
```typescript
// 이미지 업로드
eventUploadImg: (path: string) => void

// 이미지 체크
eventImgCheck: () => void

// 노드 플레이어 데이터 관리
setNodePlayerData: (pageID, stepID, data) => void
getNodePlayerData: (pageID, stepID) => void
```

## 4. 상태 관리

### 4.1 주요 상태 변수
```typescript
// 카메라 관련
const ifWinCamera = ref()
const ifCanvasW = ref<string>('')
const ifCanvasH = ref<string>('')
const ifCanvasX = ref<string>('')
const ifCanvasY = ref<string>('')

// 오디오 관련
const ifWinRecord = ref()
const ifWinRecordCallbackId = ref<string>('')
const audioList = ref<ISoundInfo[]>([])

// 학습 진행 관련
const ifIsCompleteContents = ref<boolean>(false)
const ifCurrentMenuScore = ref<number>(0)

// 이미지 저장 그룹
const imageSaveGroup = ref<ImageDataItem[]>([])

// STT 관련
const refSttStart = ref<boolean>(false)
```

## 5. 에러 처리 및 안전성

### 5.1 주요 안전성 기능
- **DOM 준비 상태 확인**: iframe이 완전히 로드된 후에만 작업 수행
- **타임아웃 처리**: 캡처 작업에 10초 타임아웃 설정
- **에러 캐치**: 모든 주요 함수에 try-catch 블록 적용
- **권한 확인**: 카메라, 마이크 접근 권한 사전 확인

### 5.2 자동재생 차단 대응
```typescript
handleAutoplay: (mediaElement: HTMLMediaElement) => Promise<void>
```
- 브라우저의 자동재생 정책에 대응
- 사용자 상호작용이 필요한 경우 안내 버튼 표시
- 재생 실패 시 자동 재시도 메커니즘

## 6. 성능 최적화

### 6.1 메모리 관리
- **스트림 정리**: 카메라/오디오 스트림 사용 후 자동 정리
- **이벤트 리스너 관리**: 중복 이벤트 리스너 방지
- **이미지 데이터 관리**: base64 이미지 데이터 효율적 저장

### 6.2 비동기 처리
- **Promise 기반**: 모든 네트워크 요청을 Promise로 처리
- **타임아웃 관리**: 장시간 실행되는 작업에 타임아웃 설정
- **에러 복구**: 실패한 작업에 대한 자동 재시도

## 7. 보안 고려사항

### 7.1 데이터 검증
- **입력값 검증**: 모든 사용자 입력에 대한 타입 및 형식 검증
- **파일 형식 검증**: 업로드되는 이미지 파일의 형식 및 크기 검증
- **API 키 관리**: 환경변수를 통한 API 키 관리

### 7.2 CORS 및 보안
- **iframe 보안**: postMessage를 통한 안전한 통신
- **API 호출 보안**: 적절한 헤더와 인증 정보 포함

## 8. 확장성 및 유지보수

### 8.1 모듈화
- **기능별 그룹화**: 카메라, 오디오, STT 등 기능별로 함수 그룹화
- **재사용 가능한 함수**: 공통 기능을 별도 함수로 분리

### 8.2 설정 관리
- **환경별 설정**: 개발/스테이징/운영 환경별 서버 URL 관리
- **동적 설정**: 런타임에 변경 가능한 설정값 관리

## 9. 테스트 및 디버깅

### 9.1 로깅 시스템
- **상세한 로그**: 모든 주요 작업에 대한 상세 로그 출력
- **에러 추적**: 에러 발생 시 상세한 스택 트레이스 제공
- **성능 모니터링**: 주요 작업의 실행 시간 측정

### 9.2 디버깅 도구
- **콘솔 출력**: 개발 환경에서의 상세한 디버깅 정보
- **상태 모니터링**: 주요 상태 변수의 변화 추적

## 10. 제한사항 및 주의사항

### 10.1 브라우저 호환성
- **모던 브라우저**: ES6+ 기능 사용으로 인한 구형 브라우저 제한
- **WebRTC 지원**: 카메라/마이크 기능은 WebRTC 지원 브라우저 필요

### 10.2 성능 고려사항
- **이미지 크기**: 대용량 이미지 처리 시 메모리 사용량 증가
- **동시 처리**: 여러 멀티미디어 작업 동시 실행 시 성능 저하 가능
